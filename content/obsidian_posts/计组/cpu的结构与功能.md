
# CPU的结构：

## CPU的功能：

CPU基本功能即：取指令，分析指令和执行指令。  
CPU需要具备的功能为：指令控制，操作控制，时间控制，数据加工和处理中断功能。

## CPU结构框图：

### CPU各功能实现的依赖硬件

- 指令控制——PC，IR(存放当前指令的寄存器)
- 操作控制与时间控制——CU时序电路
- 数据加工：进行加减乘除运算——ALU
- 处理中断——中断系统

## CPU的寄存器：

1，**用户可见寄存器**：

- 通用寄存器：存放操作数；作为某个寻址方式的专用寄存器
- 数据寄存器：存放操作数
- 地址寄存器：用于存放地址，或作特殊寻址方式的属性——基址的基地址，变址的变址寄存器，堆栈的栈指针
- 条件码寄存器：存放用于分支判断的条件码

**2，控制和状态寄存器：**  
(1)控制寄存器：  
MAR：存放被访问的存储单元的地址；  
MDR：存放欲存储的数据或刚被读取出的数据  
PC：程序计数器，存放当前指令地址  
IR：存放当前欲执行的指令。  
【其中MAR, MDR, IR用户不可见，PC用户可见】

(2)状态寄存器：  
状态寄存器：存放条件码  
PSW寄存器：存放程序状态字  
，

# 指令周期：

## 指令周期基本概念：

指令周期即是CPU取出并执行一条指令的全部时间。  
指令周期包括取指周期和执行周期：

- 取指周期——完成取指令和分析指令的操作
- 执行周期——完成执行阶段的操作

各个指令的指令周期均有所不同：  
JMP指令：由于执行阶段无需访存，在取指周期后段即可完成执行。故指令周期即是取指周期。  
ADD指令：共需要访存两次，故指令周期就包括两个存取周期。  
间接寻址：指令周期就包括：取指周期，间址周期，执行周期。

故按照各个周期的目的性可分为：  
取指周期——取指令  
间址周期——取有效地址  
执行周期——取操作数  
中断周期——保存程序断点

## 指令周期的数据流：

**取指周期的数据流：**

![image-2.png](image-2.png)

**间址周期的数据流：**

CU检查IR中的内容，以便确定是否还有间址操作。

**中断周期数据流：**

![image.png](image.png)

# 程序流水：

## 如何提高机器速度：

- 提高访存速度：  
    采用高速芯片；采用cache-主存结构；多体并行结构访存；
- 提高IO与主机之间的传送速度：  
    采用DMA方式；多总线并行；
- 提高运算速度：  
    使用高速芯片；改进算法；快速进位链
- 提高整机处理能力：  
    使用高速器件；改进系统结构，开发系统的并行性。

## 系统的并行性：

### 什么是并行：

- 并发：两个或两个以上的事件在同一时间段发生；
- 同时：两个或两个以上事件在同一时刻发生。

### 并行性的等级：

过程级（程序，进程之间）：粗粒度，通过软件实现；  
指令级（指令之间）：细粒度，通过硬件实现。

## 指令流水原理：

**指令的串行执行：**  
完成一条指令，可分为取指令和执行指令两个步骤，即执行指令和取指令逐个交替进行。  
**指令的二级流水：**  
事实上，当执行指令时，访存部件空闲，此时就可以执行下一条指令的取指令动作。得到二级流水图如下：  
![image-4.png](image-4.png)

## 影响指令流水效率加倍的因素：

1，指令执行时间 > 取指时间：  
取指阶段要等待一段时间，不能立即传送给执行部件，需要先放入指令部件缓冲区。  
2，条件转移指令的影响：  
必须要等待上一条指令执行结束后，才能够判断出下一条指令的地址，这个过程就造成了时间损失。  
解决方法：**猜测法**——  
当从取指阶段进入执行阶段时，指令部件仍按顺序预取下一条指令，  
若猜测成功，则无时间损失；若猜测失败，则丢弃该指令，再取新的指令。

## 指令的六级流水

先将指令完成过程进一步细分：

- 取指(FI)——从存储器中取出指令，并存入缓冲区中；
- 指令译码(DI)——确定操作性质和操作数地址计算方式；
- 计算操作数地址(CO)——计算操作数的有效地址；
- 取操作数(FO);
- 执行指令(EI);
- 写存储器(WO);  
    故得到指令的六级流水如图：  
    ![image-5 1.png](数据库/image-5%201.png)  
    可见：串行完成这9条指令的耗费时间为6 * 9 = 54个时间单位；  
    并行操作则耗费14个时间单位。

## 影响指令流水线性能的因素：

主要分为结构相关，数据相关和控制相关三个方面。

### 结构相关：

即指令在重叠执行过程中，不同指令争用同一功能部件产生的资源冲突所产生的。  
例如同时需要执行访存和取指令，两者相冲突：

- 解决办法1：  
    指令完成前一条访存指令后，先暂停一个时钟周期后，再取后一条指令。
- 解决办法2：  
    设置两个存储器存放操作数和指令。
- 解决办法3：  
    采用指令预取技术，将指令全部预先取出来，适用于访存周期很短的情况。

### 数据相关：

即不同指令因重叠操作，可能改变操作数的读写访问顺序  
例如执行：

```
SUB R1, R2, R3
ADD R4, R5, R1
```

ADD指令是将上一条指令中R1的执行结果作为操作数运算的。  
但在流水线执行中是先提取R1中的指令，发生了逻辑错误。  
解决方法：

- **后推法**——  
    遇到数据相关的指令时，停顿后续指令的运行，直至前面的指令结果已经生成。
- **旁路技术**——  
    直接将执行结果送到其他指令所需要的地方。

#### 不同类型的数据相关冲突：

设指令i在指令j之前：  
1，写后读相关：  
指令j试图在指令i写入前读出存储器内容。  
2，读后写相关：  
指令j试图在指令i读出存储器前，就写入数据。  
3，写后写相关：  
指令j试图在指令i写入前就写入该存储器。

### 控制相关：

即主要由条件转移指令的预取功能造成：  
若是预判错误，会造成大量的周期浪费。  
如图中先预取指令4，但直到WO执行结束判断需要跳转，又会重新执行正确的。  
![image-6.png](image-6.png)

## 流水线性能：

主要通过**吞吐率**，**加速比**，**效率**三个指标来衡量。

### 吞吐率：

**单位时间内流水线所完成指令或输出结果的数量。**  
设m级流水线的各段时间为,  
![image-7.png](image-7.png)  
实际吞吐率：  
T =   
最大吞吐率：  
T = 

### 加速比：

**m级的流水线速度与等功能的非流水线速度之比。**  
设流水线各段时间为t，  
完成n条指令在m级流水线上共需：  
T1 = m _t + (n-1)_ t  
在等效非流水线上：  
T2 = nm * t  
故：S = 

### 效率：

**流水线中各功能段的利用率。**  
流水线有建立时间和排空时间，不可能一直在工作。  
故流水线中各功能段的利用率  
效率 = 流水线各段处于工作时间的时空区流水线中各段总的时空区  
= 

## 流水线的多发技术：

### 超标量技术：

**即在每个时钟周期内并发处理多条独立指令。**  
不能调整指令的执行顺序，而是通过编译优化技术，把可并行执行的指令(如数据相关类型)搭配起来。  
在硬件方面，需要配置多个功能部件和译码电路。  
![image-8.png](image-8.png)

### 超流水线技术：

将一些流水线寄存器插入流水线中，**实现在一个时钟周期内流水线的再次分段。**  
硬件方面即是将一个功能部件使用多次。  
![image-9.png](image-9.png)

### 超长指令字技术：

**由编译程序挖出指令间的潜在的并行性，将多条能并行操作的指令组合成一条。**  
其组合形成的超长指令字具有多个操作码字段。  
在硬件方面采用多个处理部件。  
![image-10.png](image-10.png)

## 流水线结构：

### 指令流水线结构：

将完成一条指令分成7段，每完成一段都需要一个时钟周期。  
故7级流水的效率是不采用流水技术的7倍。

### 运算流水线：

完成浮点加减运算，可分为 对阶，尾数求和，规格化三段。  
硬件方面实现：相邻两个步骤均需要一个锁存或寄存器，保证流水线的饱满程度。  
![image-11.png](image-11.png)

## 中断系统：

### 概述：

#### 引起中断的因素：

- 人为中断的因素：转管指令
- 程序性事故：溢出，非法操作码...
- 硬件故障
- I/O设备请求
- 外部事件：键盘中断程序等

#### 中断系统需要解决的问题：

1，中断源如何向CPU提出请求？  
2，如何处理同时多个请求？  
3，CPU相应中断的时机与方式  
4，如何保护现场？  
5，如何寻找程序入口？  
6，如何恢复现场，并返回？  
7，如何处理多级中断？

### 中断请求标记和中断判优逻辑：

#### 中断请求标记：

用来判断是什么原因，哪一个中断源发出的中断请求。在中断系统中设置相应的中断请求标记触发器，记作INTR。形如：  
![image-13.png](image-13.png)  
INTR既可以集成作为一个寄存器放在CPU的中断系统中，也可以分散在各个中断源的接口电路中。

#### 中断判优逻辑：

当某一时刻，有多个中断源发出请求，按照对应的优先逻辑按序处理。  
即——**该中断源若不按时处理，对于机器的影响程度大小：**

- 电源掉电优先级最高；
- 定点运算溢出优先级较高；
- IO设备，速度快的设备优先级较高。

中断判优逻辑既可以用硬件实现，也可以通过软件控制。

##### 硬件实现(排队器)：

一是对应中断请求触发器分散在各个接口电路中，即实现为链式排队器。  
二是排队器设置在CPU内，例如：  
![image-14.png](image-14.png)  
图中高级别的请求被置为1时，即可封住低级别请求的通行。

##### 软件排队：

假设A,B,C优先级降序排列，则通过以下控制逻辑实现：  
![image-15.png](image-15.png)

### 中断服务程序入口地址的寻找：

#### 硬件向量法：

利用硬件产生向量地址，再由向量地址找到中断服务程序的入口地址。  
通过向量地址找到中断服务程序入口地址的方法：

- 向量地址内放一条无条件转移指令，执行指令，即可无条件转向对应的入口地址；
- 设置向量地址表：该表设在存储器内，存储单元的地址为向量地址，内容为入口地址。

#### 软件查询法：

流程即如软件排队的控制逻辑实现。

### 中断响应：

**响应中断的条件：**  
即允许中断触发器ENTP被置为1.  
**响应中断的时间：**  
指令执行周期结束时刻，由CPU发出查询信号